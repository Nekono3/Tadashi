<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Full Reading Practice</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            line-height: 1.4;
            font-size: 16px;
        }

        .header {
            background-color: #ffffff;
            padding: 12px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            height: 60px;
        }

        .ielts-logo {
            display: none;
        }

        .test-info {
            display: flex;
            align-items: center;
            gap: 30px;
            font-size: 14px;
            color: #333;
        }

        .audio-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
        }

        .audio-icon {
            width: 16px;
            height: 16px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>') no-repeat center;
        }

        .header-icons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .telegram-link {
            color: #0088cc;
            text-decoration: none;
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .telegram-link:hover {
            text-decoration: underline;
        }

        .telegram-link::before {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            background-color: currentColor;
            -webkit-mask-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.78 18.65l.28-4.23l7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3L3.64 12c-.88-.25-.89-1.37.2-1.64l16.56-6.4c.75-.29 1.4.22 1.2.94l-2.67 12.61c-.22.95-1.13 1.18-1.78.73l-4.5-3.32l-2.23 2.15c-.47.44-1.29.21-1.48-.37z"/></svg>');
            mask-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.78 18.65l.28-4.23l7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3L3.64 12c-.88-.25-.89-1.37.2-1.64l16.56-6.4c.75-.29 1.4.22 1.2.94l-2.67 12.61c-.22.95-1.13 1.18-1.78.73l-4.5-3.32l-2.23 2.15c-.47.44-1.29.21-1.48-.37z"/></svg>');
            background-size: contain;
            background-repeat: no-repeat;
        }

        #volume-slider {
            -webkit-appearance: none;
            width: 80px;
            height: 4px;
            background: #ddd;
            outline: none;
            border-radius: 2px;
            cursor: pointer;
        }

        #volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #333;
            cursor: pointer;
        }

        #volume-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #333;
            cursor: pointer;
            border: none;
        }

        .icon {
            width: 20px;
            height: 20px;
            cursor: pointer;
            opacity: 0.7;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .icon:hover {
            opacity: 1;
        }
        
        #play-pause-btn {
            background: none;
            border: none;
            padding: 0;
        }

        .main-container {
            margin-top: 60px;
            display: flex;
            flex-direction: column;
            background: #ffffff;
            height: calc(100vh - 60px); /* Full height minus header */
        }

        .panels-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .passage-panel {
            flex: 1;
            padding: 20px 20px 100px;
            overflow-y: auto;
            min-width: 200px; /* Minimum width */
        }

        /* Passage Content */
        .text-center {
            text-align: center;
        }
        .reading-passage h4.text-center {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
        }
       
        .reading-passage p {
            margin-bottom: 1.2em;
        }

        .question ul li label {
            display: block;
            margin-top: 8px;
            cursor: pointer;
        }

        .questions-panel {
            flex: 1;
            padding: 20px 20px 100px;
            overflow-y: auto;
            min-width: 200px; /* Minimum width */
            border-left: 1px solid #e0e0e0;
        }

        .resizer {
            width: 10px;
            cursor: col-resize;
            background-color: #f0f0f0;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="30" viewBox="0 0 10 30"><path d="M4 11h2v2H4zM4 15h2v2H4zM4 19h2v2H4z" fill="%23888"/></svg>');
            background-repeat: no-repeat;
            background-position: center;
            flex-shrink: 0;
            flex-grow: 0;
        }

        /* Left Panel */
        .left-panel {
            width: 100%;
            padding: 20px;
        }

        /* Right Panel */
        .right-panel {
            display: none;
            width: 50%;
            padding: 20px;
            position: relative;
        }

        .help-button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 20px;
        }

        .help-button:hover {
            background: #357abd;
        }

        .section-title {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .people-section {
            margin-bottom: 30px;
        }

        .people-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #ccc;
        }

        .people-table th {
            text-align: left;
            padding: 10px;
            font-weight: bold;
            border: 1px solid #ddd;
        }

        .people-table td {
            padding: 8px 10px;
            border: 1px solid #ddd;
        }

        .person-name {
            font-size: 16px;
        }

        .question-number {
            background: white;
            border: 1px solid #4a90e2;
            padding: 4px 8px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 14px;
            color: #4a90e2;
            min-width: 30px;
            text-align: center;
        }

        .assigned-responsibility {
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 14px;
            border: 1px solid #ddd;
        }

        .responsibilities-section {
            margin-bottom: 30px;
        }

        .responsibility-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .responsibility-item {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: move;
            font-size: 16px;
            text-align: center;
            transition: all 0.2s;
        }

        .responsibility-item:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .responsibility-item.dragging {
            opacity: 0.5;
        }

        .questions-section {
            margin-bottom: 20px;
        }

        .question-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .instruction {
            margin-bottom: 20px;
            font-size: 16px;
            color: #666;
        }

        /* Map Styles */
        .map-container {
            position: relative;
            margin: 20px 0;
            display: flex;
            justify-content: center;
        }

        .map-svg {
            border: 2px solid #333;
            background: white;
        }

        .map-room {
            fill: #f9f9f9;
            stroke: #333;
            stroke-width: 1;
        }

        .map-text {
            font-family: Arial, sans-serif;
            font-size: 13px;
            text-anchor: middle;
            fill: #333;
        }

        .map-number {
            font-family: Arial, sans-serif;
            font-size: 16px;
            font-weight: bold;
            text-anchor: middle;
            fill: #333;
        }

        .room-labels {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .room-label {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: move;
            font-size: 16px;
            text-align: center;
            transition: all 0.2s;
        }

        .room-label:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .room-label.dragging {
            opacity: 0.5;
        }

        /* Navigation Arrows */
        .nav-arrows {
            position: fixed;
            bottom: 100px;
            right: 20px;
            display: flex;
            gap: 5px;
            z-index: 101;
        }

        .nav-arrow {
            width: 50px;
            height: 50px;
            background: #333;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: bold;
        }

        .nav-arrow:hover {
            background: #555;
        }

        .nav-arrow:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Bottom Navigation - Exact Match */
        .nav-row {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #ffffff;
        
            padding: 0;
            display: flex;
            align-items: center;
            height: 80px;
            z-index: 100;
        }

        .footer__questionWrapper___1tZ46 {
            display: flex;
            align-items: center;
            margin-right: 20px;
        }


        .footer__questionNo___3WNct {
            background: none;
            border: none;
            padding: 10px 15px;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s;
        }

        .footer__questionNo___3WNct:hover {
            background-color: #f8f9fa;
        }

        .section-prefix {
            font-size: 16px;
        }

        .sectionNr {
            font-size: 16px;
            font-weight: bold;
        }

        .attemptedCount {
            font-size: 14px;
            color: #666;
            margin-left: 5px;
            font-weight: 400; /* Normal weight */
        }

        @media (max-width: 768px) {
            .attemptedCount {
                display: none;
            }
        }

        .footer__questionWrapper___1tZ46.selected .attemptedCount {
            display: none;
        }

        .footer__subquestionWrapper___9GgoP {
            display: none;
            gap: 2px;
            margin-left: 10px;
        }

        .footer__questionWrapper___1tZ46.selected .footer__subquestionWrapper___9GgoP {
            display: flex;
        }

        .subQuestion {
            width: 32px;
            height: 32px;
            border: 1px solid #ccc;
            background: white;
            color: #333;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            border-radius: 2px;
        }

        .subQuestion.answered {
            background-color: #e9ecef;
            border-color: #ddd;
        }
        .subQuestion.correct {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }
        .subQuestion.incorrect {
            background-color: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .subQuestion:hover {
            background-color: #f0f0f0;
            border-color: #999;
        }

        .subQuestion.active {
            background-color: #4a90e2;
            color: white;
            border-color: #4a90e2;
        }

        .subQuestion.completed {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .footer__deliverButton___3FM07 {
            margin-left: auto;
            margin-right: 20px;
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ccc;
            padding: 12px 20px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s, border-color 0.2s;
            min-width: 170px;
            justify-content: center;
        }

        .footer__deliverButton___3FM07:hover {
            background-color: #e0e0e0;
            border-color: #bbb;
        }

        .footer__deliverButton___3FM07:disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
            border-color: #ddd;
        }

        .fa-check::before {
            content: "✓";
        }

        .hidden {
            display: none !important;
        }

        /* Context Menu */
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            min-width: 140px;
        }

        .context-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            font-size: 16px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-menu-item:hover {
            background-color: #f8f9fa;
        }

        .context-menu-item:last-child {
            border-bottom: none;
        }

        .highlight {
            background-color: #ffff00;
        }

        .comment-highlight {
            background-color: #90EE90;
            position: relative;
            cursor: help;
        }

        .comment-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            white-space: nowrap;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .comment-highlight:hover .comment-tooltip {
            opacity: 1;
        }

        .question {
            margin-bottom: 40px;
        }
        .question p {
            margin-bottom: 10px;
        }
        .question ul, .question .people-table {
            margin-top: 0;
        }
        .question-prompt {
            margin-bottom: 20px;
        }
        .question ul {
            list-style: none;
            padding-left: 0;
        }
        .question ul li {
            margin-bottom: 5px;
        }
        .answer-input {
            border: 1px solid #888;
            border-radius: 4px;
            background-color: #fff;
            padding: 2px 5px;
            font-size: 16px;
            text-align: center;
            margin-right: 4px;
            margin-left: 4px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .answer-input.active-input {
            border-color: #4a90e2;
            box-shadow: 0 0 3px 1px rgba(74, 144, 226, 0.5);
        }
        .answer-input::placeholder {
            color: #999;
            font-weight: bold;
            text-align: center;
        }
        .answer-input.correct {
            border-color: #28a745;
            background-color: #e9f7ef;
        }
        .answer-input.incorrect {
            border-color: #dc3545;
            background-color: #f8d7da;
            color: #721c24;
        }
        .answer-input {
    z-index: 10;
    position: relative;
    pointer-events: auto;
}
        .drag-drop-container {
            display: flex;
            gap: 30px;
            margin-top: 20px;
            align-items: flex-start;
        }
        .recommendations-box {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
            min-height: 200px;
        }
        .drag-item {
            background: white;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: move;
            font-size: 16px;
            transition: all 0.2s;
            user-select: none;
        }
        .drag-item:hover {
            background: #e9ecef;
        }
        .drag-item.dragging {
            opacity: 0.5;
        }
        .drag-item.selected {
            border-color: #4a90e2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.5);
        }
        .drop-zone {
            border: 2px dashed #aaa;
            border-radius: 4px;
            width: 50%;
            margin-top: 19px;
            margin-bottom: 5px;
            transition: background-color 0.2s, border-color 0.2s;
            padding: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .drop-zone.drag-over {
            background-color: #e6f4ff;
            border-color: #4a90e2;
        }
        .drop-zone.correct {
            background-color: #e9f7ef;
            border-color: #28a745;
            border-style: solid;
        }
        .drop-zone.incorrect {
            background-color: #f8d7da;
            border-color: #dc3545;
            border-style: solid;
        }
        .drop-zone.disabled {
            pointer-events: none;
        }
        .drop-zone .drag-item {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            padding: 2px;
        }
        .drag-options-container {
            margin-top: 10px;
        }
        .drag-options-container .drag-item {
            display: block;
            width: fit-content;
            font-size: 15px;
            padding: 0.5px 10px;
            margin-bottom: 5px;
        }
        .drag-options-container .drag-item:last-child {
            margin-bottom: 0;
        }
        .q-number {
            color: #888;
            font-size: 14px;
            font-weight: bold;
        }
        .questions-container {
            width: 100%;
        }
        audio {
            width: 100%;
            margin-bottom: 20px;
        }
        .part-header {
            background-color: #f1f2ec;
            padding: 15px 20px;
            border: 1px solid #e0e0e0;
            text-align: left;
            margin: 10px 20px;
            border-radius: 5px;
        }
        .part-header p {
            margin: 0;
        }
        .part-header p:first-child {
            margin-bottom: 5px;
        }

        .question li.correct {
            color: #155724;
            font-weight: bold;
        }
        .question li.incorrect {
            color: #721c24;
        }
        .question li.correct::before {
            content: '✔ ';
            color: #28a745;
        }
        .question li.incorrect::before {
            content: '✖ ';
            color: #dc3545;
        }

        .example-box {
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .timer-container {
            display: flex;
            position: relative;
            cursor: default;
            color: #333;
            font-size: 16px;
            font-weight: 500;
            align-items: center;
        }
        .timer-container .timer-tooltip {
            display: none;
        }

        .timer-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 15px;
        }

        .timer-controls button {
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 50%;
            padding: 0;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        .timer-controls button:hover {
            background: #e0e0e0;
        }

        .timer-controls button svg {
            width: 20px;
            height: 20px;
            fill: #333;
        }

        .audio-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(40, 40, 40, 0.9);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
        }
        .audio-modal-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            max-width: 500px;
            padding: 20px;
        }
        .audio-modal-content p {
            font-size: 16px;
            line-height: 1.5;
            color: #eee;
        }
        .audio-modal-icon {
            margin-bottom: 20px;
        }
        .modal-play-btn {
            background-color: #000;
            color: white;
            border: 1px solid white;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }
        .modal-play-btn:hover {
            background-color: #333;
        }
        #goto-widget {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #goto-input {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #goto-btn {
            padding: 4px 10px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Styles for TRUE/FALSE/NOT GIVEN questions */
        .tf-question {
            margin-bottom: 25px;
            padding: 10px 0px;
            border-radius: 4px;
            transition: border-color 0.3s, background-color 0.3s;
        }
        .tf-question-line {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
            padding: 5px 0px;
            border-radius: 4px;
        }
        .tf-question-number, .question-number-box {
            border: 2px solid #ccc;
            padding: 2px 8px;
            margin-right: 10px;
            border-radius: 3px;
            font-weight: bold;
            transition: border-color 0.3s;
            display: inline-block;
        }
        .tf-question-text {
            padding-top: 3px;
        }
        .tf-options {
            padding-left: 5px;
        }
        .tf-option {
            display: block;
            margin-bottom: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .tf-option input[type="radio"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
        .tf-question.correct .tf-question-line {
            background-color: #e9f7ef;
        }
        .tf-question.incorrect .tf-question-line {
            background-color: #f8d7da;
        }
        .matching-question-container {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }
        .matching-options-bank {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .matching-questions {
            flex: 1.5;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .matching-question-item {
            display: flex;
            align-items: center;
            gap: 15px;

            border: 2px solid transparent;
            border-radius: 4px;
            transition: border-color 0.3s;
        }
        .matching-question-item > span {
            flex: 1;
        }
        .matching-question-item.correct {
            background-color: #e9f7ef;
            border-color: #28a745 !important;
        }
        .matching-question-item.incorrect {
            background-color: #f8d7da;
            border-color: #dc3545 !important;
        }
        .matching-question-item .drop-zone {
            width: 200px;
            flex-shrink: 0;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #aaa;
        }
        .matching-options-bank .drag-item {
            font-size: 15px;
            text-align: center;
            border: 1px solid #ccc;
            background: #f9f9f9;
        }

        .questions-panel {
            flex: 1;
            padding: 20px 20px 100px;
            overflow-y: auto;
            min-width: 200px; /* Minimum width */
            border-left: 1px solid #e0e0e0;
        }
        .matching-question-item.incorrect {
            background-color: #f8d7da;
            border-color: #dc3545 !important;
        }
        .summary-completion-container {
            margin-top: 20px;
        }
        .summary-text p {
            line-height: 2.5;
            font-size: 16px;
        }
        .summary-drop-zone {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            max-width:200px;
            height: 25px;
            border: 2px dashed #999;
            border-radius: 4px;
            margin: 0 5px;
            padding: 0 5px;
            transition: border-color 0.3s, box-shadow 0.3s, background-color 0.3s;
            color: #aaa;
            font-weight: bold;
        }
        .summary-drop-zone.filled {
            border-color: #4a90e2;
        }
        .summary-drop-zone.active-input {
             border-color: #4a90e2;
             box-shadow: none;
        }
        .summary-drop-zone .drag-item {
            font-size: 15px;
            font-weight: bold;
            background-color: transparent;
            border: none;
            padding: 0;
            text-align: center;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .summary-options-bank {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .summary-options-bank .drag-item {
            flex-grow: 1;
            min-width: 100px;
            text-align: center;
        }
        .multi-choice-question {
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 4px;
            border: 3px solid transparent;
            transition: border-color 0.3s, background-color 0.3s;
        }
        .multi-choice-option {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .multi-choice-option label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 16px;
        }
        .multi-choice-option input[type="checkbox"],
        .multi-choice-option input[type="radio"] {
            margin-right: 12px;
            transform: scale(1.3);
            accent-color: #4a90e2;
        }
        .multi-choice-option.correct {
            background-color: #e9f7ef;
        }
        .multi-choice-option.incorrect {
            background-color: #f8d7da;
        }
        .matching-question-item.incorrect {
            background-color: #f8d7da;
            border-color: #dc3545 !important;
        }
        .matching-question-item .drop-zone.filled {
            border-color: #4a90e2;
        }
        .matching-question-item .drop-zone {
            width: 200px;
            height: 40px;
        }
        .paragraph-matching-question {
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 12px;
        }
        .paragraph-matching-question .answer-input {
            width: 80px;
            flex-shrink: 0;
        }

        /* Results Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.hidden {
            display: none;
        }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #888;
        }
        .modal-content h2 {
            text-align: center;
            margin-bottom: 15px;
            color: #333;
        }
        .results-summary {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        .results-details-container {
            overflow-y: auto;
            padding-right: 10px; /* For scrollbar */
        }
        .result-row {
            display: grid;
            grid-template-columns: 40px 1fr 1fr;
            gap: 15px;
            padding: 8px 5px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 15px;
        }
        .result-row.incorrect {
            background-color: #f8d7da;
        }
        .result-row .q-num {
            font-weight: bold;
        }
        .result-row .user-ans {
            color: #555;
        }
        .result-row .correct-ans {
            color: #155724;
            font-weight: 500;
        }
        .correct-answer-display {
            font-weight: bold;
            color: #28a745;
            margin-left: 10px;
            font-size: 14px;
        }
        .correct-answer-highlight {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 4px;
        }
    </style>
</head>
<body>
    <style>
    .custom-highlight {
        background: yellow;
        cursor: pointer;
    }
    #highlight-btn, #remove-highlight-btn {
        position: absolute;
        z-index: 9999;
        display: none;
        padding: 4px 10px;
        font-size: 14px;
        border: 1px solid #888;
        border-radius: 4px;
        background: #fffbe7;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        cursor: pointer;
    }
    #remove-highlight-btn {
        background: #ffeaea;
        color: #b00;
        border-color: #b00;
    }
    </style>
    <button id="highlight-btn" type="button">Highlight</button>
    <button id="remove-highlight-btn" type="button">Remove Highlight</button>
    <div class="header">
        <div class="timer-container">
            <span class="timer-display">60:00</span>
            <div class="timer-controls">
                <button id="timer-toggle-btn" title="Pause/Resume Timer">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M8 5v14l11-7L8 5z"/></svg>
                </button>
                <button id="timer-reset-btn" title="Reset Timer">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8s-3.58-8-8-8z"/></svg>
                </button>
            </div>
        </div>
        <a href="https://t.me/cdi_reporter" target="_blank" class="telegram-link">
            CDI REPORTER
        </a>
    </div>

    <div class="main-container" id="main-container">
        <div id="passage-header-container">
            <div id="part-header-1" class="part-header">
                <p><strong>Reading Passage 2</strong></p>
                <p>Read the text and answer questions 14-26.</p>
            </div>
        </div>
        <div class="panels-container">
            <div class="passage-panel" id="passage-panel">
                <div id="passage-text-1" class="reading-passage">
                    <h4 class="text-center">The plan to bring an asteroid to Earth</h4>
                    <p style="font-style: italic; text-align: center;">Moving in orbit around our sun are millions of rocks known as asteroids. Now scientists have plans to capture one.</p>
                    <p><strong>A</strong>&nbsp;&nbsp;Send a robot into space, catch an asteroid and bring it back to Earth’s orbit. This motivated scientists and engineers at the California Institute of Technology (Caltech). A four-day workshop was dedicated to investigating the feasibility of capturing a near-Earth asteroid, bringing it closer to our planet and using it as a base for future manned spaceflight missions.</p>
                    <p>This is not something the scientists are imagining could be done some day off in the future. It is possible with the technology we have today and could be accomplished within a decade. A robotic probe could anchor to an asteroid with simple magnets or grab it with specialized claws. Alternatively, a large spacecraft could use its gravitational field to shift the orbit of a larger asteroid, sending it towards Earth.</p>
                    <p>‘Once you get over the initial reaction - You want to do what?! - it actually starts to seem like a reasonable idea,’ says engineer John Brophy, who helped organize the workshop. In fact, many of these ideas have been on the drawing board for years as part of the NASA planetary defense program against large space-based objects that might threaten Earth. And there’s no shortage of potential targets. NASA estimates there are 19,500 asteroids at least 100 meters wide within 45 million kilometers of Earth.</p>
                    <p><strong>B</strong>&nbsp;&nbsp;Though rearranging the heavens may seem an excessive undertaking, the US mission has its merits. The US already has plans to send astronauts to a near-Earth asteroid, a mission that would mean confining them in a tiny capsule for three to six months and involve all the risks of a deep-space voyage. Instead, robots could shoulder some of that burden by bringing an asteroid close enough for them to get there in just a month.</p>
                    <p>An asteroid would provide a stationary base from which to launch missions further into space. There are several advantages to this. For one, launching missions carrying materials from Earth requires a lot of power, fuel, and consequently money, because of our planet’s strong force of gravity. Since this would be far weaker on an asteroid, materials mined there could be more easily taken off the asteroid and shuttled around the solar system.</p>
                    <p>And many asteroids have a lot to offer. Some are full of metals, which can be mined and used to build space-based habitats or brought back to Earth. Others are up to one-quarter water, which would either be used for life-support or broken down into hydrogen and oxygen to make fuel. And astronomers would have the chance to get a close-up look at one of the solar system’s earliest relics, generating important scientific data. ‘Executing the asteroid retrieval plan would help demonstrate and greatly expand mankind’s space-based engineering capabilities,’ says engineer Louis Friedman, another co-organizer of the Caltech workshop. For instance, the mission would teach engineers how to capture an uncooperative target, which could be useful practice for planetary defense missions in the event of a threat from a meteoroid or comet from space approaching our planet,’ he adds.</p>
                    <p><strong>C</strong>&nbsp;&nbsp;Former astronaut Rusty Schweickart, cofounder of the B612 Foundation, an organization dedicated to protecting Earth from asteroid strikes, points out that though it would be technically feasible, shifting such a hefty and substantial target would not be easy: "You're moving the largest mother lode imaginable," he says.</p>
                    <p>Engineers would need to be absolutely certain they could control such a potentially dangerous object. "It’s the opposite of planetary defense; if you do something wrong, you have a Tunguska event," says engineer Marco Tantardini from the Planetary Society, referring to the powerful 1908 explosion above a remote Russian region thought to have been caused by a meteoroid or comet.</p>
                    <p><strong>D</strong>&nbsp;&nbsp;Still, these obstacles only add to the appeal of the project for engineers, who love to go over every potential difficulty in order to solve it. And if the challenges for a large asteroid seem too daunting, researchers could always start with a smaller asteroid perhaps 2 to 10 meters across. Last year, Brophy helped conduct a study to look at the feasibility of bringing a two-meter, 1,000-kilogram asteroid - of which there might conceivably be millions - to the International Space Station. The study suggested the asteroid could be captured robotically in something as simple as a large bag. Of course, such a small object might not have the same emotional impact as a larger target. ‘NASA isn’t going to want to go to something that is smaller than our spaceships,’ says engineer Dan Mazanek from NASA Langley Research Center.</p>
                    <p><strong>E</strong>&nbsp;&nbsp;No matter the size of the asteroid, these plans would require hefty investments. Even capturing a small asteroid would consume at least a billion dollars. Convincing taxpayers to foot such a bill could be difficult. However, private industry might be interested in getting involved. One possibility would be to push the asteroid to near-Earth orbit and then convene a commercial competition inviting anyone who wants to develop the capabilities to reach and mine the object.</p>
                    <p>However, though the undertaking might be scientifically exciting, and provide great insight into the solar system formation, this is not enough on its own to justify the expense of bringing an asteroid to Earth. Investigations of asteroids can be done much more cheaply with an unmanned spacecraft, says chemist Joseph A. Nuth from NASA’s Goddard Space Flight Center. According to Brophy, ultimately, we would be working towards bringing an asteroid closer to Earth in order to help move out into the solar system.</p>
                </div>
            </div>
            <div class="resizer" id="resizer"></div>
            <div class="questions-panel" id="questions-panel">
                <div id="questions-1" class="question-set">
                    <div class="questions-container">
                        <div class="question" data-q-start="1" data-q-end="5">
                            <div class="question-prompt">
                                <p><strong>Questions 14-18</strong><br>Reading Passage has five sections, <strong>A-E</strong>.</p>
                                <p>Choose the correct heading for each section from the list of headings below.</p>
                                <p>Write the correct number, <strong>i-viii</strong>, in boxes 14-18 on your answer sheet.</p>
                            </div>
                            <div class="matching-question-container">
                                <div class="matching-options-bank">
                                    <div class="drag-item" draggable="true" data-value="i">i The need for skill and care</div>
                                    <div class="drag-item" draggable="true" data-value="ii">ii Choosing the richest asteroid</div>
                                    <div class="drag-item" draggable="true" data-value="iii">iii The safest way to protect an asteroid</div>
                                    <div class="drag-item" draggable="true" data-value="iv">iv Obtaining support for the project</div>
                                    <div class="drag-item" draggable="true" data-value="v">v An achievable goal, not an impossible dream</div>
                                    <div class="drag-item" draggable="true" data-value="vi">vi The need for global cooperation</div>
                                    <div class="drag-item" draggable="true" data-value="vii">vii Beginning with a less challenging task</div>
                                    <div class="drag-item" draggable="true" data-value="viii">viii Practical, economic and research justifications</div>
                                </div>
                                <div class="matching-questions">
                                    <div class="matching-question-item" data-q-start="1">
                                        <span>Paragraph A</span>
                                        <div class="drop-zone" data-q-start="14"></div>
                                    </div>
                                    <div class="matching-question-item" data-q-start="2">
                                        <span>Paragraph B</span>
                                        <div class="drop-zone" data-q-start="15"></div>
                                    </div>
                                    <div class="matching-question-item" data-q-start="3">
                                        <span>Paragraph C</span>
                                        <div class="drop-zone" data-q-start="16"></div>
                                    </div>
                                    <div class="matching-question-item" data-q-start="4">
                                        <span>Paragraph D</span>
                                        <div class="drop-zone" data-q-start="17"></div>
                                    </div>
                                    <div class="matching-question-item" data-q-start="5">
                                        <span>Paragraph E</span>
                                        <div class="drop-zone" data-q-start="18"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="question" data-q-start="6" data-q-end="9">
                            <div class="question-prompt">
                                <p><strong>Questions 19-22</strong><br>Look at the following experts (Questions 19-22) and the list of statements below. Match each expert with the correct statement, A-G.</p>
                                <p>Write the correct letter, <strong>A-G</strong>, in boxes 19-22 on your answer sheet.</p>
                            </div>
                            <div class="example-box" style="font-size: 15px;">
                                <p><strong>List of statements</strong></p>
                                <ul style="list-style-type: upper-alpha; margin-left: 20px;">
                                    <li>A mistake could have serious consequences for Earth.</li>
                                    <li>It might be difficult to arouse interest in an asteroid of limited size.</li>
                                    <li>The project could be an early step in space exploration.</li>
                                    <li>An asteroid's weight makes the project extremely challenging.</li>
                                    <li>The skill gained could save Earth from future danger.</li>
                                    <li>An asteroid could be a useful landing place for a spaceship.</li>
                                    <li>Capturing an asteroid would not be an efficient method of research.</li>
                                </ul>
                            </div>
                            <div class="paragraph-matching-question">
                                <span><strong>19</strong>&nbsp;&nbsp;Louis Friedman</span>
                                <select class="answer-input" id="q19"><option value=""></option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="G">G</option></select>
                            </div>
                            <div class="paragraph-matching-question">
                                <span><strong>20</strong>&nbsp;&nbsp;Rusty Schweickart</span>
                                <select class="answer-input" id="q20"><option value=""></option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="G">G</option></select>
                            </div>
                            <div class="paragraph-matching-question">
                                <span><strong>21</strong>&nbsp;&nbsp;Dan Mazanek</span>
                                <select class="answer-input" id="q21"><option value=""></option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="G">G</option></select>
                            </div>
                            <div class="paragraph-matching-question">
                                <span><strong>22</strong>&nbsp;&nbsp;Joseph A Nuth</span>
                                <select class="answer-input" id="q22"><option value=""></option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="G">G</option></select>
                            </div>
                        </div>
                        <div class="question" data-q-start="10" data-q-end="13">
                            <div class="question-prompt">
                                <p><strong>Questions 23-26</strong><br>Complete the summary below.</p>
                                <p>Choose <strong>ONE WORD ONLY</strong> from the passage for each answer.</p>
                                <p>Write your answers in boxes 23-26 on your answer sheet.</p>
                            </div>
                            <div class="summary-text">
                                <p style="font-weight: bold; text-align: center;">The merits of the US mission</p>
                                <p>Capture of an asteroid would reduce the time that astronauts travelling to it needed to spend in space. An asteroid could also act as a <input type="text" class="answer-input" id="q23" placeholder="23" size="15"> for further space travel and exploration. The fact that an asteroid would have weaker <input type="text" class="answer-input" id="q24" placeholder="24" size="15"> would allow easier movement of resources.</p>
                                <p>These resources include <input type="text" class="answer-input" id="q25" placeholder="25" size="15"> which could be used in space or on Earth and <input type="text" class="answer-input" id="q26" placeholder="26" size="15"> which would either be used for life-support or broken down into hydrogen and oxygen to make fuel.</p>
                                <p>And astronomers would have the chance to get a close-up look at one of the solar system’s earliest relics, generating important scientific data. The mission could provide data on the history of our sun and planets. It could also be good practice if there was a threat to Earth from a body from space.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Arrows -->
    <div class="nav-arrows">
        <button class="nav-arrow" onclick="previousQuestion()" id="prevBtn">‹</button>
        <button class="nav-arrow" onclick="nextQuestion()" id="nextBtn">›</button>
    </div>

    <!-- Bottom Navigation -->
    <nav class="nav-row perScorableItem" aria-label="Questions">
        <div class="footer__questionWrapper___1tZ46 multiple" role="tablist">
            <button role="tab" class="footer__questionNo___3WNct" onclick="switchToPart(2)">
                <span>
                    <span aria-hidden="true" class="section-prefix">Part </span>
                    <span class="sectionNr" aria-hidden="true">2</span>
                    <span class="attemptedCount" aria-hidden="true">0 of 13</span>
                </span>
            </button>
            <div class="footer__subquestionWrapper___9GgoP">
                <button class="subQuestion scorable-item" onclick="goToQuestion(14)"><span class="sr-only">Question 14</span><span aria-hidden="true">14</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(15)"><span class="sr-only">Question 15</span><span aria-hidden="true">15</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(16)"><span class="sr-only">Question 16</span><span aria-hidden="true">16</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(17)"><span class="sr-only">Question 17</span><span aria-hidden="true">17</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(18)"><span class="sr-only">Question 18</span><span aria-hidden="true">18</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(19)"><span class="sr-only">Question 19</span><span aria-hidden="true">19</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(20)"><span class="sr-only">Question 20</span><span aria-hidden="true">20</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(21)"><span class="sr-only">Question 21</span><span aria-hidden="true">21</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(22)"><span class="sr-only">Question 22</span><span aria-hidden="true">22</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(23)"><span class="sr-only">Question 23</span><span aria-hidden="true">23</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(24)"><span class="sr-only">Question 24</span><span aria-hidden="true">24</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(25)"><span class="sr-only">Question 25</span><span aria-hidden="true">25</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(26)"><span class="sr-only">Question 26</span><span aria-hidden="true">26</span></button>
            </div>
        </div>
        
        <button id="deliver-button" aria-label="Review your answers" class="footer__deliverButton___3FM07">
            <i class="fa fa fa-check" aria-hidden="true"></i>
            <span>Check Answers</span>
        </button>
    </nav>

    <!-- Context Menu -->
    <div id="contextMenu" class="context-menu">
        <div id="menu-highlight" class="context-menu-item" onclick="highlightText()">
            Highlight
        </div>
        <div id="menu-note" class="context-menu-item" onclick="addNote()">
            Note
        </div>
        <div id="menu-clear" class="context-menu-item" onclick="clearHighlight()">
            Clear
        </div>
        <div id="menu-clear-all" class="context-menu-item" onclick="clearAllHighlights()">
            Clear All
        </div>
    </div>

    <div id="results-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeResultsModal()">&times;</button>
            <h2>Results</h2>
            <div class="results-summary">
                <p>Score: <span id="results-score"></span> / 13</p>
                <p>IELTS Band: <span id="results-band"></span></p>
            </div>
            <div id="results-details" class="results-details-container">
                <!-- Results for each question will be injected here -->
            </div>
        </div>
    </div>

    <script>
    // --- HIGHLIGHT FEATURE ---
    (function() {
        const highlightBtn = document.getElementById('highlight-btn');
        const removeHighlightBtn = document.getElementById('remove-highlight-btn');
        let lastSelection = null;
        let highlightTarget = null;

        // Helper: get selection and check if in passage/questions
        function getValidSelection() {
            const sel = window.getSelection();
            if (!sel.rangeCount) return null;
            const range = sel.getRangeAt(0);
            if (sel.isCollapsed) return null;
            // Only allow highlight in passage or questions
            const passage = document.getElementById('passage-panel');
            const questions = document.getElementById('questions-panel');
            if (
                passage.contains(range.commonAncestorContainer) ||
                questions.contains(range.commonAncestorContainer)
            ) {
                return range;
            }
            return null;
        }

        // Show highlight button near selection
        function showHighlightBtn(range) {
            const rect = range.getBoundingClientRect();
            highlightBtn.style.top = (window.scrollY + rect.bottom + 4) + 'px';
            highlightBtn.style.left = (window.scrollX + rect.left) + 'px';
            highlightBtn.style.display = 'block';
        }

        // Hide highlight button
        function hideHighlightBtn() {
            highlightBtn.style.display = 'none';
        }

        // Show remove highlight button near span
        function showRemoveBtn(span) {
            const rect = span.getBoundingClientRect();
            removeHighlightBtn.style.top = (window.scrollY + rect.bottom + 4) + 'px';
            removeHighlightBtn.style.left = (window.scrollX + rect.left) + 'px';
            removeHighlightBtn.style.display = 'block';
            highlightTarget = span;
        }

        // Hide remove highlight button
        function hideRemoveBtn() {
            removeHighlightBtn.style.display = 'none';
            highlightTarget = null;
        }

        // Highlight selected text
        highlightBtn.addEventListener('click', function() {
            if (!lastSelection) return;
            const range = lastSelection;
            const span = document.createElement('span');
            span.className = 'custom-highlight';
            span.appendChild(range.extractContents());
            range.insertNode(span);
            window.getSelection().removeAllRanges();
            hideHighlightBtn();
        });

        // Remove highlight
        removeHighlightBtn.addEventListener('click', function() {
            if (!highlightTarget) return;
            const parent = highlightTarget.parentNode;
            while (highlightTarget.firstChild) {
                parent.insertBefore(highlightTarget.firstChild, highlightTarget);
            }
            parent.removeChild(highlightTarget);
            hideRemoveBtn();
        });

        // Listen for selection changes
        document.addEventListener('selectionchange', function() {
            hideHighlightBtn();
            const range = getValidSelection();
            if (range) {
                lastSelection = range;
                showHighlightBtn(range);
            } else {
                lastSelection = null;
            }
        });

        // Hide buttons on scroll or click elsewhere
        document.addEventListener('scroll', function() {
            hideHighlightBtn();
            hideRemoveBtn();
        }, true);
        document.addEventListener('mousedown', function(e) {
            if (!highlightBtn.contains(e.target) && !removeHighlightBtn.contains(e.target)) {
                hideHighlightBtn();
                hideRemoveBtn();
            }
        });

        // Show remove button on highlight click
        document.addEventListener('click', function(e) {
            if (e.target.classList && e.target.classList.contains('custom-highlight')) {
                e.preventDefault();
                showRemoveBtn(e.target);
            }
        });
    })();
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE VARIABLES ---
        let currentPassage = 1;
        let currentQuestion = 1;
        let selectedRange = null;
        let timeInSeconds = 3600;
        let timerInterval;
        let draggedItem = null;
        let activeQuestionElement = null;
        let selectedDragItem = null;

        // --- DOM ELEMENTS ---
        const timerDisplay = document.querySelector('.timer-display');
        const timerToggleButton = document.getElementById('timer-toggle-btn');
        const timerResetButton = document.getElementById('timer-reset-btn');
        const deliverButton = document.getElementById('deliver-button');
        const resizer = document.getElementById('resizer');
        const passagePanel = document.getElementById('passage-panel');
        const questionsPanel = document.getElementById('questions-panel');
        const contextMenu = document.getElementById('contextMenu');

        // Remove legacy context menu highlight logic if present (now handled by new feature)

        // --- ICON SVGs ---
        const playIcon = '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M8 5v14l11-7L8 5z"/></svg>';
        const pauseIcon = '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';

        // --- ANSWERS ---
        const correctAnswers = {
            '1': 'v', '2': 'viii', '3': 'i', '4': 'vii', '5': 'iv',
            '6': 'E', '7': 'D', '8': 'B', '9': 'G',
            '10': 'base', '11': 'gravity', '12': 'metals', '13': 'water'
        };

        // --- INITIALIZATION ---
        function initialize() {
            startTimer();
            initializeDragAndDrop();
            setupCheckboxLimits();
            setupExampleHeading();
            switchToPart(1); // Also calls goToQuestion(1) and updateNavigation
            
            document.body.addEventListener('input', updateAllIndicators);
            document.body.addEventListener('change', updateAllIndicators);
            deliverButton.addEventListener('click', checkAnswers);
            timerToggleButton.addEventListener('click', toggleTimer);
            timerResetButton.addEventListener('click', resetTimer);

            // Add click listeners to question containers for navigation
            document.querySelectorAll('[data-q-start]').forEach(el => {
                el.addEventListener('click', () => {
                    const qNum = parseInt(el.dataset.qStart, 10);
                    if (currentQuestion !== qNum) {
                        goToQuestion(qNum);
                    }
                });
            });

            resizer.addEventListener('mousedown', initResize, false);
            initializeContextMenu();
        }

        // --- CORE TEST LOGIC ---

        function checkAnswers() {
            clearInterval(timerInterval);
            let score = 0;
            const totalQuestions = 13;
            const resultsDetailsContainer = document.getElementById('results-details');
            resultsDetailsContainer.innerHTML = '';

            document.querySelectorAll('.correct, .incorrect, .correct-answer-highlight').forEach(el => {
                el.classList.remove('correct', 'incorrect', 'correct-answer-highlight');
            });
            document.querySelectorAll('.correct-answer-display').forEach(el => el.remove());

            for (let i = 1; i <= totalQuestions; i++) {
                const questionKey = String(i);
                let correctAnswer = correctAnswers[questionKey];
                let userAnswer = '';
                let isCorrect = false;
                let element;

                const tfRadio = document.querySelector(`input[name="q${i}"]:checked`);
                const textInput = document.getElementById(`q${i}`);
                const dropZone = document.querySelector(`.drop-zone[data-q-start="${i}"]`);

                if (tfRadio) { // TF/NG or Multiple Choice Radio
                    userAnswer = tfRadio.value;
                    element = tfRadio.closest('.tf-question');
                    if (userAnswer === correctAnswer) {
                        isCorrect = true;
                    }
                } else if (textInput && textInput.tagName === 'INPUT') { // Text input
                    userAnswer = textInput.value.trim();
                    element = textInput;
                     if (Array.isArray(correctAnswer)) {
                        isCorrect = correctAnswer.some(ans => userAnswer.toLowerCase() === ans.toLowerCase());
                    } else {
                        isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
                    }
                } else if (textInput && textInput.tagName === 'SELECT') { // Select/Dropdown
                    userAnswer = textInput.value;
                    element = textInput.closest('.paragraph-matching-question');
                    if (userAnswer === correctAnswer) {
                        isCorrect = true;
                    }
                } else if (dropZone) { // Drag and Drop
                    const droppedItem = dropZone.querySelector('.drag-item');
                    userAnswer = droppedItem ? droppedItem.dataset.value : '';
                    element = dropZone;
                    if (userAnswer === correctAnswer) {
                        isCorrect = true;
                    }
                }

                if (isCorrect) {
                    score++;
                    if (element) element.classList.add('correct');
                } else {
                    if (element) element.classList.add('incorrect');
                }
                
                // For showing results in the modal
                 let userAnswerDisplay = userAnswer || 'Not Answered';
                 let correctAnswerDisplay = Array.isArray(correctAnswer) ? correctAnswer.join(' / ') : correctAnswer;

                 const resultRow = `
                    <div class="result-row ${isCorrect ? '' : 'incorrect'}">
                        <span class="q-num">${i}</span>
                        <span class="user-ans">${userAnswerDisplay}</span>
                        <span class="correct-ans">${correctAnswerDisplay}</span>
                    </div>`;
                resultsDetailsContainer.innerHTML += resultRow;
            }

            // --- Update Score and Band ---
            document.getElementById('results-score').textContent = score;
            document.getElementById('results-band').textContent = calculateBandScore(score);
            document.getElementById('results-modal').classList.remove('hidden');
        }

        function calculateBandScore(score) {
            if (score >= 12) return '9.0';
            const mapping = {
                13: 9.0, 12: 9.0, 11: 8.5, 10: 8.5, 9: 8.0, 8: 8.0, 7: 7.5,
                6: 7.5, 5: 7.0, 4: 7.0, 3: 7.0, 2: 6.5, 1: 6.5
            };
            return mapping[score] || 0.0;
        }

        function getUserAnswer(qNum) {
            const textInput = document.getElementById(`q${qNum}`);
            const radioInput = document.querySelector(`input[name="q${qNum}"]:checked`);
            const dropZone = document.querySelector(`.drop-zone[data-q-start="${qNum}"]`);

            if (textInput) { // Handles <input type="text"> and <select>
                return { value: textInput.value, text: textInput.value || 'N/A' };
            }
            if (radioInput) {
                return { value: radioInput.value, text: radioInput.value };
            }
            if (dropZone) {
                const droppedItem = dropZone.querySelector('.drag-item');
                return { 
                    value: droppedItem ? droppedItem.dataset.value : null, 
                    text: droppedItem ? droppedItem.textContent.trim() : 'N/A' 
                };
            }
            return { value: null, text: 'N/A' };
        }

        function displayCorrectAnswer(qNum, correctAnswer) {
            // Handle radio button questions by highlighting the correct label
            const correctRadioInput = document.querySelector(`input[name="q${qNum}"][value="${correctAnswer}"]`);
            if (correctRadioInput) {
                const parentOption = correctRadioInput.closest('.tf-option, .multi-choice-option');
                if (parentOption) {
                    parentOption.classList.add('correct-answer-highlight');
                    return;
                }
            }

            // Handle text inputs, select dropdowns, and others by showing the answer next to them
            const inputEl = document.getElementById(`q${qNum}`);
            if (inputEl) {
                const displaySpan = document.createElement('span');
                displaySpan.className = 'correct-answer-display';
                displaySpan.textContent = ` ✓ ${correctAnswer}`;
                inputEl.insertAdjacentElement('afterend', displaySpan);
                return; // Done
            }
            
            // Fallback for questions identified by a container (e.g., some T/F/NG questions)
            const element = findQuestionElement(qNum);
            if (element) {
                const displaySpan = document.createElement('span');
                displaySpan.className = 'correct-answer-display';
                displaySpan.textContent = ` ✓ ${correctAnswer}`;
                const itemContainer = element.querySelector('.tf-question-text');
                if (itemContainer) {
                     itemContainer.appendChild(displaySpan);
                } else {
                     element.appendChild(displaySpan);
                }
            }
        }
        
        function findQuestionElement(qNum) {
             return document.querySelector(`[data-q-start="${qNum}"]`);
        }

        function addResultToModal(qNum, userAnswer, correctAnswer, isCorrect) {
            const resultsDetails = document.getElementById('results-details');
            const row = document.createElement('div');
            row.className = 'result-row';
            if (!isCorrect) {
                row.classList.add('incorrect');
            }
            row.innerHTML = `
                <span class="q-num">${qNum}</span>
                <span class="user-ans">${userAnswer}</span>
                <span class="correct-ans">${correctAnswer}</span>
            `;
            resultsDetails.appendChild(row);
        }

        function showResultsModal() {
            document.getElementById('results-modal').classList.remove('hidden');
        }

        window.closeResultsModal = function() {
            document.getElementById('results-modal').classList.add('hidden');
        }
        
        function disableInputs() {
            deliverButton.innerHTML = `<span>Checked! View Results.</span>`;
            deliverButton.removeEventListener('click', checkAnswers);
            deliverButton.onclick = showResultsModal;

            document.querySelectorAll('input, select').forEach(el => {
                el.disabled = true;
                 if (el.matches('input[type=radio], input[type=checkbox]')) {
                     el.style.cursor = 'not-allowed';
                     el.parentElement.style.cursor = 'not-allowed';
                 }
            });
            document.querySelectorAll('.drag-item').forEach(el => {
                el.setAttribute('draggable', 'false');
                el.style.cursor = 'default';
            });
            document.querySelectorAll('.drop-zone').forEach(el => {
                el.classList.add('disabled');
            });
        }

        function checkValue(userValue, correctValue) {
            if (userValue === null || userValue === undefined) return false;
            const formattedUserValue = userValue.trim().toLowerCase();
            if (Array.isArray(correctValue)) {
                return correctValue.map(v => v.toLowerCase()).includes(formattedUserValue);
            } else {
                return formattedUserValue === String(correctValue).toLowerCase();
            }
        }

        function markQuestion(qNum, isCorrect) {
            const subQuestionBtn = document.querySelector(`.subQuestion[onclick="goToQuestion(${qNum})"]`);
            subQuestionBtn?.classList.add(isCorrect ? 'correct' : 'incorrect');

            const elementsToMark = [
                document.querySelector(`.tf-question[data-q-start="${qNum}"]`),
                document.querySelector(`.multi-choice-question[data-q-start="${qNum}"]`),
                document.querySelector(`.matching-question-item[data-q-start="${qNum}"]`),
                document.querySelector(`.drop-zone[data-q-start="${qNum}"]`),
                document.getElementById(`q${qNum}`),
                document.querySelector(`input[name="q${qNum}"]:checked`)?.closest('.tf-option'),
                document.querySelector(`input[name="q${qNum}"]:checked`)?.closest('.multi-choice-option')
            ];
            
            elementsToMark.forEach(el => {
                if (el) el.classList.add(isCorrect ? 'correct' : 'incorrect');
            });

             if (qNum === 14 || qNum === 15) {
                const multiChoiceContainer = document.querySelector('.multi-choice-question[data-q-start="14"]');
                if (multiChoiceContainer) multiChoiceContainer.classList.add(isCorrect ? 'correct' : 'incorrect');
             } else if (qNum >= 1 && qNum <= 5) {
                const pMatchInput = document.getElementById(`q${qNum}`);
                if (pMatchInput) pMatchInput.classList.add(isCorrect ? 'correct' : 'incorrect');
             } else if (qNum >= 38 && qNum <= 40) {
                // For this group, individual options are marked, not the container.
             }
        }

        window.switchToPart = function(partNumber) {
            currentPassage = partNumber;
            document.querySelectorAll('.reading-passage, .question-set, .part-header').forEach(el => el.classList.add('hidden'));
            document.getElementById(`passage-text-${partNumber}`)?.classList.remove('hidden');
            document.getElementById(`questions-${partNumber}`)?.classList.remove('hidden');
            document.getElementById(`part-header-${partNumber}`)?.classList.remove('hidden');
            
            const firstQuestionOfPart = { 1: 1 }[partNumber];
            goToQuestion(firstQuestionOfPart);
        }
        
        window.goToQuestion = function(questionNumber) {
            currentQuestion = questionNumber;

            let passageNumber = 1;
            
            if (currentPassage !== passageNumber) {
                switchToPart(passageNumber);
                return; 
            }

            if (activeQuestionElement) {
                activeQuestionElement.classList.remove('active-question', 'active-input');
            }

            let targetEl = document.querySelector(`[data-q-start="${questionNumber}"]`);

            if (targetEl) {
                activeQuestionElement = targetEl;
                 if (targetEl.matches('input[type="text"]') || targetEl.matches('select')) {
                     targetEl.classList.add('active-input');
                 } else {
                     targetEl.classList.add('active-question');
                 }
                 scrollIntoViewIfNeeded(targetEl);
            } else {
                 const pMatch = document.querySelector(`.paragraph-matching-question select[id="q${questionNumber}"]`);
                 if(pMatch) {
                    activeQuestionElement = pMatch;
                    pMatch.classList.add('active-input');
                    scrollIntoViewIfNeeded(pMatch);
                 }
            }

            updateNavigation();
        }
        
        // --- UI & NAVIGATION ---

        function updateNavigation() {
            document.querySelectorAll('.footer__questionWrapper___1tZ46').forEach((wrapper, index) => {
                wrapper.classList.toggle('selected', index + 1 === currentPassage);
            });
            
            document.querySelectorAll('.subQuestion').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.subQuestion[onclick="goToQuestion(${currentQuestion})"]`)?.classList.add('active');
            
            document.getElementById('prevBtn').disabled = currentQuestion === 1;
            document.getElementById('nextBtn').disabled = currentQuestion === 13;
        }
        
        function selectDragItem(item) {
            if (selectedDragItem) {
                selectedDragItem.classList.remove('selected');
            }
            selectedDragItem = item;
            if (selectedDragItem) {
                selectedDragItem.classList.add('selected');
            }
        }
        
        window.nextQuestion = () => currentQuestion < 13 && goToQuestion(currentQuestion + 1);
        window.previousQuestion = () => currentQuestion > 1 && goToQuestion(currentQuestion - 1);

        function updateAllIndicators() {
            updateAnsweredIndicators();
            updateAttemptedCounts();
        }
        
        function updateAnsweredIndicators() {
            for (let qNum = 1; qNum <= 13; qNum++) {
                const btn = document.querySelector(`.subQuestion[onclick="goToQuestion(${qNum})"]`);
                if (!btn || btn.classList.contains('correct') || btn.classList.contains('incorrect')) continue;

                let isAnswered = false;
                const textInput = document.getElementById(`q${qNum}`);
                const radioInput = document.querySelector(`input[name="q${qNum}"]:checked`);
                const dropZone = document.querySelector(`.drop-zone[data-q-start="${qNum}"]`);
                const selectInput = document.querySelector(`select[id="q${qNum}"]`);
                
                if (textInput && textInput.value.trim() !== '') {
                    isAnswered = true;
                } else if (radioInput) {
                    isAnswered = true;
                } else if (dropZone && dropZone.querySelector('.drag-item')) {
                    isAnswered = true;
                } else if (selectInput && selectInput.value !== '') {
                    isAnswered = true;
                }
                
                btn.classList.toggle('answered', isAnswered);
            }
        }
        
        function updateAttemptedCounts() {
            const passageConfigs = {
                    1: { total: 13, start: 1, end: 13 }
            };
            
            for(const partNum in passageConfigs){
                const config = passageConfigs[partNum];
                const answeredQuestions = new Set();

                for(let i = config.start; i <= config.end; i++){
                    const btn = document.querySelector(`.subQuestion[onclick="goToQuestion(${i})"]`);
                    if(btn && btn.classList.contains('answered')) {
                        answeredQuestions.add(i);
                    }
                }
                
                const countDisplay = document.querySelector(`.footer__questionWrapper___1tZ46:nth-child(${partNum}) .attemptedCount`);
                if (countDisplay) countDisplay.textContent = `${answeredQuestions.size} of ${config.total}`;
            }
        }

        function scrollIntoViewIfNeeded(element) {
            const panel = element.closest('.questions-panel, .passage-panel');
            const panelRect = panel.getBoundingClientRect();
            const elementRect = element.getBoundingClientRect();
            if (elementRect.top < panelRect.top || elementRect.bottom > panelRect.bottom) {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
        
        // --- DRAG AND DROP ---
        
        function initializeDragAndDrop() {
            document.querySelectorAll('.drag-item').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('click', () => selectDragItem(item));
            });
            document.querySelectorAll('.drop-zone, .matching-options-bank').forEach(zone => {
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('dragleave', handleDragLeave);
                zone.addEventListener('drop', handleDrop);
            });
        }

        function handleDragStart(e) {
            draggedItem = e.target;
            setTimeout(() => e.target.classList.add('dragging'), 0);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedItem = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            const targetZone = e.currentTarget;
            targetZone.classList.remove('drag-over');

            if (draggedItem) {
                const sourceZone = draggedItem.parentElement;
                if (sourceZone === targetZone) return;

                const existingItem = targetZone.querySelector('.drag-item');
                if (existingItem) {
                    // If target already has an item, move it back to source
                    if (sourceZone.classList.contains('matching-options-bank')) {
                        insertOptionInOrder(existingItem, sourceZone);
                    } else {
                        sourceZone.appendChild(existingItem);
                    }
                }

                // If dragging back to the options bank, restore order
                if (targetZone.classList.contains('matching-options-bank')) {
                    insertOptionInOrder(draggedItem, targetZone);
                } else {
                    targetZone.appendChild(draggedItem);
                    targetZone.classList.add('filled');
                }

                if (sourceZone.classList.contains('drop-zone') && !sourceZone.querySelector('.drag-item')) {
                    sourceZone.classList.remove('filled');
                }

                updateAllIndicators();
            }
        }

        // Helper: Insert a drag-item back into the options bank in its original order
        function insertOptionInOrder(item, optionsBank) {
            const allOptions = Array.from(optionsBank.querySelectorAll('.drag-item')).filter(opt => opt !== item);
            const allOptionValues = allOptions.map(opt => opt.getAttribute('data-value'));
            const originalOrder = [
                'i', 'ii', 'iii', 'iv', 'v', 'vi', 'vii', 'viii'
            ];
            const itemValue = item.getAttribute('data-value');
            let insertIndex = 0;
            for (let i = 0; i < originalOrder.length; i++) {
                if (originalOrder[i] === itemValue) {
                    // Find the next option in order that is present, insert before it
                    for (let j = i + 1; j < originalOrder.length; j++) {
                        const nextValue = originalOrder[j];
                        const nextOption = allOptions.find(opt => opt.getAttribute('data-value') === nextValue);
                        if (nextOption) {
                            optionsBank.insertBefore(item, nextOption);
                            return;
                        }
                    }
                    // If no next option, append at end
                    optionsBank.appendChild(item);
                    return;
                }
            }
            // Fallback: append at end
            optionsBank.appendChild(item);
        }
        
        // --- MISC HELPERS ---
        
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval); // Ensure no multiple intervals
            timerInterval = setInterval(() => {
                timeInSeconds--;
                const minutes = Math.floor(timeInSeconds / 60);
                const seconds = timeInSeconds % 60;
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                if (timeInSeconds <= 0) {
                    clearInterval(timerInterval);
                    timerDisplay.textContent = "Time's up!";
                    // checkAnswers(); // Disabled to prevent modal from opening automatically.
                }
            }, 1000);
            timerToggleButton.innerHTML = pauseIcon;
        }

        function pauseTimer() {
            clearInterval(timerInterval);
            timerToggleButton.innerHTML = playIcon;
        }

        function toggleTimer() {
            // Check based on the icon currently displayed
            if (timerToggleButton.innerHTML.includes('M6 19h4V5H6v14z')) { // Check for pause icon shape
                pauseTimer();
            } else {
                startTimer();
            }
        }

        function resetTimer() {
            pauseTimer();
            timeInSeconds = 3600;
                // Optionally, could also reset all the answers here.
                // For now, just resets the timer display and restarts it.
                timerDisplay.textContent = '60:00';
                // Consider if you want to automatically start the timer after reset, or leave it paused.
                 startTimer();
            
        }
        
        function setupCheckboxLimits() {
            const checkboxGroups = [
                { name: 'q38-40', limit: 3 }
            ];
            checkboxGroups.forEach(group => {
                const checkboxes = document.querySelectorAll(`input[name="${group.name}"]`);
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        const checkedCount = document.querySelectorAll(`input[name="${group.name}"]:checked`).length;
                        if (checkedCount > group.limit) checkbox.checked = false;
                        updateAllIndicators();
                    });
                });
            });
        }

        function setupExampleHeading() {
            const exampleHeading = document.querySelector('.drag-item[data-value="x"]');
            const exampleDropZone = document.querySelector('.drop-zone[data-question="q_H_example"]');
            if (exampleHeading && exampleDropZone) {
                exampleDropZone.innerHTML = '';
                exampleDropZone.appendChild(exampleHeading);
                exampleDropZone.classList.add('correct', 'disabled');
                exampleHeading.setAttribute('draggable', 'false');
                exampleHeading.style.cursor = 'default';
            }
        }
        
        function initResize(e) {
            e.preventDefault();
            const startX = e.clientX;
            const startWidth = passagePanel.offsetWidth;
            
            const doDrag = (e) => {
                const newWidth = startWidth + e.clientX - startX;
                if (newWidth > 200 && (document.body.clientWidth - newWidth - resizer.offsetWidth) > 200) {
                    passagePanel.style.flex = `0 0 ${newWidth}px`;
                }
            };
            const stopDrag = () => {
                window.removeEventListener('mousemove', doDrag, false);
                window.removeEventListener('mouseup', stopDrag, false);
            };
            
            window.addEventListener('mousemove', doDrag, false);
            window.addEventListener('mouseup', stopDrag, false);
        }
        
        // --- CONTEXT MENU (Highlighting) ---
        
        function initializeContextMenu() {
            const panels = [passagePanel, questionsPanel];
            let targetElementForClear = null;

            // This listener simply tracks the last valid text selection in either panel.
            document.addEventListener('selectionchange', () => {
                const selection = window.getSelection();
                if (selection && !selection.isCollapsed && selection.toString().trim().length > 0) {
                    const range = selection.getRangeAt(0);
                    if (panels.some(panel => panel.contains(range.commonAncestorContainer))) {
                        selectedRange = range;
                        targetElementForClear = null; // New selection overrides clearing a specific element
                    }
                }
            });

            const showContextMenu = (e) => {
                const target = e.target;
                const isClickOnHighlight = target.closest('.highlight, .comment-highlight');
                const isSelectionActive = selectedRange && selectedRange.toString().trim().length > 0;
                
                let showMenu = false;

                if (isClickOnHighlight) {
                    document.getElementById('menu-highlight').style.display = 'none';
                    document.getElementById('menu-note').style.display = 'none';
                    document.getElementById('menu-clear').style.display = 'block';
                    document.getElementById('menu-clear-all').style.display = 'block';
                    contextMenu.targetElementForClear = isClickOnHighlight;
                    showMenu = true;
                } else if (isSelectionActive && panels.some(panel => panel.contains(selectedRange.commonAncestorContainer))) {
                    document.getElementById('menu-highlight').style.display = 'flex';
                    document.getElementById('menu-note').style.display = 'flex';
                    document.getElementById('menu-clear').style.display = 'none';
                    document.getElementById('menu-clear-all').style.display = 'block'; // Always show clear all
                    showMenu = true;
                }

                if (showMenu) {
                    e.preventDefault();
                    contextMenu.style.display = 'block';
                    const menuHeight = contextMenu.offsetHeight;
                    const menuWidth = contextMenu.offsetWidth;
                    let left = e.pageX;
                    let top = e.pageY;
                    if (left + menuWidth > window.innerWidth) left = window.innerWidth - menuWidth - 5;
                    if (top + menuHeight > window.innerHeight) top = e.pageY - menuHeight - 5;
                    else top = e.pageY - menuHeight - 5;
                    
                    contextMenu.style.left = `${left}px`;
                    contextMenu.style.top = `${top}px`;
                }
            };

            panels.forEach(panel => {
                panel.addEventListener('contextmenu', showContextMenu);
            });

            document.addEventListener('click', (e) => {
                if (contextMenu.style.display === 'block' && !contextMenu.contains(e.target)) {
                    closeContextMenu();
                }
            });
        }

        function closeContextMenu() {
            contextMenu.style.display = 'none';
            selectedRange = null; // Clear range after menu closes
        }

        function unwrapElement(element) {
            const parent = element.parentNode;
            if (!parent) return;
            while (element.firstChild) {
                parent.insertBefore(element.firstChild, element);
            }
            parent.removeChild(element);
            parent.normalize();
        }

        window.highlightText = () => {
            if (selectedRange && !selectedRange.collapsed) {
                const span = document.createElement('span');
                span.className = 'highlight';
                span.appendChild(selectedRange.extractContents());
                selectedRange.insertNode(span);
            }
            closeContextMenu();
            window.getSelection().removeAllRanges();
        };

        window.addNote = () => {
            const note = prompt('Enter your note:');
            if (note && selectedRange && !selectedRange.collapsed) {
                const span = document.createElement('span');
                span.className = 'comment-highlight';
                const tooltip = document.createElement('span');
                tooltip.className = 'comment-tooltip';
                tooltip.textContent = note;
                span.appendChild(selectedRange.extractContents());
                span.appendChild(tooltip);
                selectedRange.insertNode(span);
            }
            closeContextMenu();
            window.getSelection().removeAllRanges();
        };

        window.clearHighlight = () => {
             const elementToClear = contextMenu.targetElementForClear;
             if (elementToClear) {
                 unwrapElement(elementToClear);
             }
             closeContextMenu();
             window.getSelection().removeAllRanges();
        };
        
        window.clearAllHighlights = () => {
            document.querySelectorAll('.highlight, .comment-highlight').forEach(unwrapElement);
            closeContextMenu();
            window.getSelection().removeAllRanges();
        };

        // --- START THE APP ---
        initialize();
    });
    </script>
</body>
</html>